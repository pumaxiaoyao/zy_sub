<?php
/**
 * Created by PhpStorm.
 * User: fish
 * Date: 2018/3/7
 * Time: 16:02
 */

namespace app\cqssc\controller;


use app\api\model\AccMoney;
use app\api\model\AccMychg;
use app\api\model\AccUsers;
use app\cqssc\model\SscLottery;
use app\cqssc\model\SscOrder;
use think\Config;
use app\auth\controller\BaseController;

class KaijiangController extends BaseController
{
    protected function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
        Config::load(APP_PATH . 'cqssc/config.php');
    }

    /**
     * 最新开奖
     * @return array
     * @throws \think\Exception
     * @throws \think\exception\DbException
     */
    public function lastLty()
    {
        $lastLottery             = SscLottery::getLastest()->toArray();
        $details = $this->cqsscResult($lastLottery['opencode']);
        $lastLottery['opencode'] = explode(',', $lastLottery['opencode']);
        $lastLottery['details']  = $details;
        $lastLottery['code']     = 'ssc';

        $get = request()->only('range', 'get');
        $error = $this->validate($get, [
            'range' => 'alphaDash'
        ]);
        if (true !== $error) {
            $this->jsonData['status'] = 0;
            $this->jsonData['msg'] = $error;
            return $this->jsonData;
        }
        $range = isset($get['range']) ? $get['range'] : 'all';
        $where = [];
        $where['tokenint'] = $this->user->tokenint;
        if ('all' !== $range)
        {
            $timeRange = get_time_range($range);
            $where['create_time'] = ['between' , [$timeRange['start'], $timeRange['end']]];
        }
        $unclearMoney = SscOrder::getUnclearMoney($where);
        $lastLottery['unclear_money'] = $unclearMoney;

        return $lastLottery;
    }

    /**
     * 开奖
     * @return string
     * @throws \think\exception\DbException
     */
    public function kjSsc()
    {
        echo "cqssc\tstart\tkaijiang...\n";
        $start     = time();
        $lastest   = SscLottery::getLastest();
        $expect    = $lastest['expect'];
        $open_code = $lastest['opencode'];
        // 检查是否已经开奖的
        if (SscLottery::expectLotteried($expect)) {
            echo "\t[ " . $expect . ' ]  Already Lottery ' . "\t";
        }

        // 开奖结果
        $result = $this->cqsscResult($open_code);
        // 兑奖
        $msg = $this->setLucky($lastest, $result);
        // 更新开奖状态
        $lottery             = SscLottery::getByExpect($expect);
        $lottery->is_lottery = 1;
        $lottery->save();
        $end    = time();
        $offset = $end - $start;
        echo "cqssc\t" . $msg . "\t" . "Lottery Successful\t[Time: {$offset} s]\n\n";
    }

    /**
     * 开奖
     * @return string
     * @throws \think\exception\DbException
     */
    public function lottery()
    {
        $lastest   = SscLottery::getLastest();
        $expect    = $lastest['expect'];
        $open_code = $lastest['opencode'];
        // 检查是否已经开奖的
        if (SscLottery::expectLotteried($expect)) {
            return "\t[ " . $expect . ' ]  Already Lottery ' . "\t";
        }

        // 开奖结果
        $result = $this->cqsscResult($open_code);
        // 兑奖
        $msg = $this->setLucky($lastest, $result);
        // 更新开奖状态
        $lottery             = SscLottery::getByExpect($expect);
        $lottery->is_lottery = 1;
        $lottery->save();

        return $msg . "\t" . 'Lottery Successful';
    }

    /**
     * 开奖
     *
     * @return array
     * @throws \think\exception\DbException
     */
    public function manualLottery()
    {
        $start     = time();
        $lastest   = SscLottery::getLastest();
        $expect    = $lastest['expect'];
        $open_code = $lastest['opencode'];
        // 检查是否已经开奖的
        if (SscLottery::expectLotteried($expect)) {
            return [
                'code' => 0,
                'msg'  => "重庆时时彩 [ " . $expect . " ]  已经开奖"
            ];
        }

        // 开奖结果
        $result = $this->cqsscResult($open_code);
        // 兑奖
        $msg = $this->setLucky($lastest, $result);
        // 更新开奖状态
        $lottery             = SscLottery::getByExpect($expect);
        $lottery->is_lottery = 1;
        $lottery->save();

        $end    = time();
        $offset = $end - $start;

        return [
            'code' => 1,
            'msg'  => "重庆时时彩 " . $msg . " 开奖成功 [Time: " . $offset . " s]"
        ];
    }

    /**
     * 派奖
     *
     * @param $lastest
     * @param $result
     *
     * @return string
     * @throws \think\exception\DbException
     */
    private function setLucky($lastest, $result)
    {

        $expect = $lastest['expect'];
        $config = config('ssc_open_type');

        // 获取所有本期未开奖注单
        $orders     = SscOrder::getNotOpenOrdersByExpect($expect);
        $orders_num = count($orders);

        if (empty($orders->toArray())) {
            return '[ ' . $expect . ' ] has no orders';
        }

        // 遍历注单
        $upd_orders = [];
        foreach ($orders as $order) {
            $upd_order['id'] = $order->id;
            $type            = array_search($order['mark_a'], $config);
            $bet_contents    = $result[$type];
            if (in_array($order['mark_b'], $bet_contents)) {
                $upd_order['open_ret'] = 1;
                $upd_order['open_win'] = $order['win'] - $order['money'];
                // 派奖
                $this->setBonus($order);
            } else {
                $upd_order['open_ret'] = 0;
                $upd_order['open_win'] = 0 - $order['money'];
            }
            $upd_order['open_stu']    = 1;
            $upd_order['open_code']   = $lastest['opencode'];
            $upd_order['status']      = 1;
            $upd_order['update_time'] = time();
            unset($upd_order['create_time']);
            array_push($upd_orders, $upd_order);
            // 返水，无关是否中奖
            $this->setFs($order);
        }
        $orderModel = new SscOrder();
        $orderModel->isUpdate()->saveAll($upd_orders);

        return "[ " . $expect . " ] $orders_num 注订单";
    }

    /**
     * @param $order
     *
     * @throws \think\exception\DbException
     */
    private function setFs($order)
    {
        $user = AccUsers::getUserByTokenint($order->tokenint);
        $this->addFs($user, $order);
        if ($user->admin) {
            $admin = AccUsers::get($user->admin);
            $this->addFs($admin, $order);
        }
        if ($user->manager) {
            $manager = AccUsers::get($user->manager);
            $this->addFs($manager, $order);
        }
        if ($user->agent) {
            $agent = AccUsers::get($user->agent);
            $this->addFs($agent, $order);
        }
    }

    /**
     * @param $user
     * @param $order
     *
     * @throws \think\exception\DbException
     */
    private function addFs($user, $order)
    {
        $userMoney = AccMoney::getMoneyByUser($user->tokenint);
        if (!$userMoney) {
            AccMoney::initMoney($user);
        }
        $chg = 0;
        switch ($user->type) {
            case 3:
                $chg = $order->fs_gv;
                break;
            case 2:
                $chg = $order->fs_mv;
                break;
            case 1:
                $chg = $order->fs_av;
                break;
            case 0:
                $chg = $order->fs_sv;
                break;
        }
        $chg_column['tokenint']     = $user->tokenint;
        $chg_column['username']     = $user->username;
        $chg_column['nickname']     = $user->nickname;
        $chg_column['c_type']       = CHG_BET_FS;
        $chg_column['c_old']        = AccMoney::getCashByUser($user->tokenint);
        $chg_column['chg']          = $chg;
        $chg_column['cur']          = $chg_column['c_old'] + $chg_column['chg'];
        $chg_column['con']          = '重庆时时彩下注返水';
        $chg_column['opr_tokenint'] = '';
        $chg_column['opr_nickname'] = '';
        $chg_column['opr_username'] = '';
        $chg_column['opr_ip']       = request()->ip();
        $chg_column['opr_time']     = get_cur_date();
        $chg_column['opr_mark']     = $order->order_no;
        $chg_id                     = add_chg($chg_column);

        $chg = AccMychg::get($chg_id);
        // 更新用户余额
        upd_money($chg->tokenint, $chg->cur);
    }

    /**
     * 发放奖金
     *
     * @param $order
     *
     * @throws \think\exception\DbException
     */
    private function setBonus($order)
    {
        $user                       = AccUsers::getUserByTokenint($order->tokenint);
        $chg_column['tokenint']     = $user->tokenint;
        $chg_column['username']     = $user->username;
        $chg_column['nickname']     = $user->nickname;
        $chg_column['c_type']       = CHG_BET_LUCKY;
        $chg_column['c_old']        = AccMoney::getCashByUser($user->tokenint);
        $chg_column['chg']          = $order->win;
        $chg_column['cur']          = $chg_column['c_old'] + $chg_column['chg'];
        $chg_column['con']          = '重庆时时彩中奖';
        $chg_column['opr_tokenint'] = '';
        $chg_column['opr_nickname'] = '';
        $chg_column['opr_username'] = '';
        $chg_column['opr_ip']       = request()->ip();
        $chg_column['opr_time']     = get_cur_date();
        $chg_column['opr_mark']     = '订单号：' . $order->order_no . ', ' . $order->expect . ', ' . $order->mark_a . ', ' . $order->mark_b;
        $chg_id                     = add_chg($chg_column);

        $chg = AccMychg::get($chg_id);
        // 更新用户余额
        upd_money($chg->tokenint, $chg->cur);
    }

    /**
     * 暴露给外部调用
     *
     * @param $open_code
     *
     * @return array
     */
    public function getCqsscResult($open_code)
    {
        return $this->cqsscResult($open_code);
    }

    /**
     * 开奖结果
     *
     * @param $open_code
     *
     * @return array
     */
    private function cqsscResult($open_code)
    {
        $open_codes = explode(',', $open_code);

        $ret = [];
        // 第一球
        $ret['ball_1'] = $this->generateSingleRes($open_codes[0]);

        // 第二球
        $ret['ball_2'] = $this->generateSingleRes($open_codes[1]);

        // 第三球
        $ret['ball_3'] = $this->generateSingleRes($open_codes[2]);

        // 第四球
        $ret['ball_4'] = $this->generateSingleRes($open_codes[3]);

        // 第五球
        $ret['ball_5'] = $this->generateSingleRes($open_codes[4]);

        // 总和、龙虎和
        $ret['dragon_and_tiger'] = [];
        $sum                     = array_sum($open_codes);
        if ($sum < 23) {
            $dragon_and_tiger_res = '总和小';
        } else {
            $dragon_and_tiger_res = '总和大';
        }
        array_push($ret['dragon_and_tiger'], $dragon_and_tiger_res);
        if ($sum % 2 === 0) {
            $half = '总和双';
        } else {
            $half = '总和单';
        }
        array_push($ret['dragon_and_tiger'], $half);
        // 龙虎
        if ($open_codes[0] > $open_codes[4]) {
            $cmp = '龙';
        } elseif ($open_codes[0] < $open_codes[4]) {
            $cmp = '虎';
        } else {
            $cmp = '和';
        }
        array_push($ret['dragon_and_tiger'], $cmp);


        // 前三球
        $front_3        = array_slice($open_codes, 0, 3);
        $front_3_res    = $this->generate3ballsRes($front_3);
        $ret['front_3'] = [$front_3_res];

        // 中三球
        $medium_3        = array_slice($open_codes, 1, 3);
        $medium_3_res    = $this->generate3ballsRes($medium_3);
        $ret['medium_3'] = [$medium_3_res];

        // 后三球
        $end_3        = array_slice($open_codes, 2, 3);
        $end_3_res    = $this->generate3ballsRes($end_3);
        $ret['end_3'] = [$end_3_res];


        return $ret;
    }

    /**
     * 计算特码的大小单双
     *
     * @param $code
     *
     * @return array
     */
    private function generateSingleRes($code)
    {
        $ret = [];
        array_push($ret, $code);

        if ($code % 2 === 0) {
            array_push($ret, '双');
        } else {
            array_push($ret, '单');
        }

        if ($code <= 4) {
            array_push($ret, '小');
        } else {
            array_push($ret, '大');
        }
        return $ret;
    }

    /**
     * 计算三球开奖结果
     *
     * @param $open_codes
     *
     * @return string
     */
    private function generate3ballsRes($open_codes)
    {
        sort($open_codes);
        $first     = $open_codes[0];
        $second    = $open_codes[1];
        $third     = $open_codes[2];
        $straights = [
            '012',
            '123',
            '234',
            '345',
            '456',
            '567',
            '678',
            '789',
            '089',
            '019'
        ];
        $join_str  = implode($open_codes);
        if ($first === $second && $first === $third && $second === $third) {
            $ret = '豹子';
        } elseif (($first === $second && $second !== $third) || ($first === $third && $first !== $second) || ($second === $third && $first !== $third)) {
            $ret = '对子';
        } elseif (in_array($join_str, $straights)) {
            $ret = '顺子';
        } elseif ((abs($first - $second) === 1) || (abs($second - $third) === 1) || (abs($third - $first) === 9)) {
            $ret = '半顺';
        } else {
            $ret = '杂六';
        }

        return $ret;
    }

    /**
     * 长龙统计
     *
     * @return void
     */
    public function longDragon()
    {
        $return = [];
        $lotteries = SscLottery::getToday();

        $ball_1_big_small = [];
        $ball_1_even_odd = [];

        $ball_2_big_small = [];
        $ball_2_even_odd = [];

        $ball_3_big_small = [];
        $ball_3_even_odd = [];

        $ball_4_big_small = [];
        $ball_4_even_odd = [];

        $ball_5_big_small = [];
        $ball_5_even_odd = [];

        $sum_big_small = [];
        $sum_even_odd = [];
        $sum_dragon_tiger = [];


        foreach ($lotteries as $key => $lottery) {
            $result = $this->cqsscResult($lottery->opencode);
            // 两面
            array_push($ball_1_big_small, $result['ball_1'][2]);
            array_push($ball_1_even_odd, $result['ball_1'][1]);
            
            array_push($ball_2_big_small, $result['ball_2'][2]);
            array_push($ball_2_even_odd, $result['ball_2'][1]);
            
            array_push($ball_3_big_small, $result['ball_3'][2]);
            array_push($ball_3_even_odd, $result['ball_3'][1]);
            
            array_push($ball_4_big_small, $result['ball_4'][2]);
            array_push($ball_4_even_odd, $result['ball_4'][1]);
            
            array_push($ball_5_big_small, $result['ball_5'][2]);
            array_push($ball_5_even_odd, $result['ball_5'][1]);

            array_push($sum_big_small, $result['dragon_and_tiger'][0]);
            array_push($sum_even_odd, $result['dragon_and_tiger'][1]);
            array_push($sum_dragon_tiger, $result['dragon_and_tiger'][2]);
        }
        $ball_1_big_small = $this->calcBigAndSmallMost($ball_1_big_small, "第一球-");
        $ball_1_even_odd = $this->calcOddAndEvenMost($ball_1_even_odd, "第一球-");
        
        $ball_2_big_small = $this->calcBigAndSmallMost($ball_2_big_small, "第二球-");
        $ball_2_even_odd = $this->calcOddAndEvenMost($ball_2_even_odd, "第二球-");
        
        $ball_3_big_small = $this->calcBigAndSmallMost($ball_3_big_small, "第三球-");
        $ball_3_even_odd = $this->calcOddAndEvenMost($ball_3_even_odd, "第三球-");
        
        $ball_4_big_small = $this->calcBigAndSmallMost($ball_4_big_small, "第四球-");
        $ball_4_even_odd = $this->calcOddAndEvenMost($ball_4_even_odd, "第四球-");
        
        $ball_5_big_small = $this->calcBigAndSmallMost($ball_5_big_small, "第五球-");
        $ball_5_even_odd = $this->calcOddAndEvenMost($ball_5_even_odd, "第五球-");

        $sum_big_small = $this->calcSumBigAndSmallMost($sum_big_small);
        $sum_even_odd = $this->calcSumOddAndEvenMost($sum_even_odd);
        $sum_dragon_tiger = $this->calcSumDragonTigerMost($sum_dragon_tiger, "总和");

        $return = array_merge($ball_1_big_small, $ball_1_even_odd, $ball_2_big_small, 
                            $ball_2_even_odd, $ball_3_big_small, $ball_3_even_odd, 
                            $ball_4_big_small, $ball_4_even_odd, $ball_5_big_small, 
                            $ball_5_even_odd, $sum_big_small, $sum_even_odd, $sum_dragon_tiger);

        $newReturn = [];
        foreach ($return as $k => $item) {
            if (!empty($item)) {
                array_push($newReturn, $item);
            }
        }
        usort($newReturn, 'cmp_num');
        $this->jsonData['data'] = $newReturn;
        return $this->jsonData;
    }
    
    /**
     * 总和龙虎长龙统计
     *
     * @param array $array
     * @return array
     */
    private function calcSumDragonTigerMost($array, $prefix = "")
    {
        $calc_odd = []; // jishu
        $calc_even = []; // oushu
        $count_odd = 0;
        $count_even = 0;
        foreach ($array as $item) {
            if ($item === "龙") {
                $count_even++;
                $calc_odd[$count_odd][] = $item;
            } else {
                $count_odd++;
                $calc_even[$count_even][] = $item;
            }
        }
        $calc_odd = $this->genReturn($calc_odd, "龙", $prefix);
        $calc_even = $this->genReturn($calc_even, "虎", $prefix);
        return [$calc_odd, $calc_even];
    }


    /**
     * 奇偶长龙统计
     *
     * @param array $array
     * @return array
     */
    private function calcSumOddAndEvenMost($array, $prefix = "")
    {
        $calc_odd = []; // jishu
        $calc_even = []; // oushu
        $count_odd = 0;
        $count_even = 0;
        foreach ($array as $item) {
            if ($item === "总和单") {
                $count_even++;
                $calc_odd[$count_odd][] = $item;
            } else {
                $count_odd++;
                $calc_even[$count_even][] = $item;
            }
        }
        $calc_odd = $this->genReturn($calc_odd, "总和单", $prefix);
        $calc_even = $this->genReturn($calc_even, "总和双", $prefix);
        return [$calc_odd, $calc_even];
    }


    /**
     * 大小长龙统计
     *
     * @param array $array
     * @return array
     */
    private function calcSumBigAndSmallMost($array, $prefix = "")
    {
        $calc_big = []; // jishu
        $calc_small = []; // oushu
        $count_big = 0;
        $count_small = 0;
        foreach ($array as $item) {
            if ($item === "总和大") {
                $count_small++;
                $calc_big[$count_big][] = $item;
            } else {
                $count_big++;
                $calc_small[$count_small][] = $item;
            }
        }
        $calc_big = $this->genReturn($calc_big, "总和大", $prefix);
        $calc_small = $this->genReturn($calc_small, "总和小", $prefix);
        return [$calc_big, $calc_small];
    }

    /**
     * 奇偶长龙统计
     *
     * @param array $array
     * @return array
     */
    private function calcOddAndEvenMost($array, $prefix = "")
    {
        $calc_odd = []; // jishu
        $calc_even = []; // oushu
        $count_odd = 0;
        $count_even = 0;
        foreach ($array as $item) {
            if ($item === "单") {
                $count_even++;
                $calc_odd[$count_odd][] = $item;
            } else {
                $count_odd++;
                $calc_even[$count_even][] = $item;
            }
        }
        $calc_odd = $this->genReturn($calc_odd, "单", $prefix);
        $calc_even = $this->genReturn($calc_even, "双", $prefix);
        return [$calc_odd, $calc_even];
    }


    /**
     * 大小长龙统计
     *
     * @param array $array
     * @return array
     */
    private function calcBigAndSmallMost($array, $prefix = "")
    {
        $calc_big = []; // jishu
        $calc_small = []; // oushu
        $count_big = 0;
        $count_small = 0;
        foreach ($array as $item) {
            if ($item === "大") {
                $count_small++;
                $calc_big[$count_big][] = $item;
            } else {
                $count_big++;
                $calc_small[$count_small][] = $item;
            }
        }
        $calc_big = $this->genReturn($calc_big, "大", $prefix);
        $calc_small = $this->genReturn($calc_small, "小", $prefix);
        return [$calc_big, $calc_small];
    }

    /**
     * 统计最大出现期数，小于连续3期不出的不统计
     *
     * @param array $array
     * @param string $name
     * @return array
     */
    private function genReturn($array, $name, $prefix)
    {
        $newArray = [];
        foreach ($array as $item) {
            $num = count($item);
            $newItem['name'] = $prefix . $name;
            $newItem['num'] = $num;
            if ($num >= 3) {
                array_push($newArray, $newItem);
            }
        }
        
        if (empty($newArray) || is_null($newArray)) {
            $return = [];
        } else {
            usort($newArray, 'cmp_num');
            $return = $newArray[0];
        }
        return $return;
    }
}
